---
title: "SCIE-PANC"
params: 
  root: "~/Documents/SCIE-PANC/Data/hg38/"
format: html
editor: visual
---

Bulk RNA analysis in the SCIE-PANC project investigating the tumor microenvironment in pancreatic adenocarcinoma

## Data and libraries initialization

```{r}
#| message: false
library(reshape2)
library(ggplot2)
library(DESeq2)
library(tidyverse)
library(biomaRt)
library(ggfortify)
library(pheatmap)
library(multideconv)
```

Download the data

```{r}
file_list <- list.files(path = params$root, 
                        pattern = "_htseq_count_all.txt$", 
                        full.names = TRUE, 
                        recursive = TRUE)

length(file_list)
```

Name the column by patient numero and genes column

```{r}
get_prefix <- function(file_path){
  fname <- basename(file_path)
  prefix <- sub("^([^_]+_[^_]+).*", "\\1", fname)
  return(prefix)
}

expr_list <- lapply(file_list, function(f){
  df <- read.table(f, header = TRUE, sep = "\t", stringsAsFactors = FALSE)
  colnames(df)[1] <- "Genes"
  prefix <- get_prefix(f)
  colnames(df)[2] <- prefix
  return(df)
})
```

Merge all the patients

```{r}
expr_matrix <- Reduce(function(x, y) merge(x, y, by = "Genes", all = TRUE), expr_list)
```

```{r}
expr_matrix <- expr_matrix[!expr_matrix$Genes %in% c("__alignment_not_unique",
                                                     "__ambiguous",
                                                     "__no_feature",
                                                     "__not_aligned",
                                                     "__too_low_aQual"), ]
dim(expr_matrix)
head(expr_matrix)
```

Add genes annotation and names

```{r}
ensembl <- useMart("ensembl", dataset = "hsapiens_gene_ensembl")

mapping <- getBM(attributes = c("ensembl_gene_id", "hgnc_symbol"),
                 filters = "ensembl_gene_id",
                 values = expr_matrix$Genes,
                 mart = ensembl)

head(mapping)
matrix_annot<-merge(mapping, expr_matrix, by.y="Genes", by.x="ensembl_gene_id")
expr_matrix <- matrix_annot[, -1]
#rownames(expr_matrix) <- expr_matrix$hgnc_symbol
head(expr_matrix)
dim(expr_matrix)
```

```{r}
expr_matrix <- expr_matrix %>%
     filter(hgnc_symbol != "") # filter "" no genes names 
dim(expr_matrix)
```

Genes doublets, keep the genes with the more count

```{r}
expr_matrix <- expr_matrix %>%
  dplyr::rowwise() %>%
  dplyr::mutate(total_counts = sum(dplyr::c_across(-hgnc_symbol))) %>% # calculate the sum of count 
  dplyr::ungroup() %>%
  dplyr::arrange(hgnc_symbol, desc(total_counts)) %>% # order the doublets
  dplyr::distinct(hgnc_symbol, .keep_all = TRUE) %>%
  dplyr::select(-total_counts)
dim(expr_matrix)
```

Preprocessing: genes filtering

1- Filtering based on genes where the total number of reads across all samples

```{r}
expr_matrix<-as.data.frame(expr_matrix)
rownames(expr_matrix) <- expr_matrix$hgnc_symbol
expr_matrix <- expr_matrix[, -1] #Genes Id in rownames
expr_matrix_mat <- as.matrix(expr_matrix)

keep <- rowSums(expr_matrix_mat) > 5  # keep all genes where the total number of reads across all samples is greater than 5
table(keep, useNA="always") 
expr_filtered <- expr_matrix_mat[keep, ]

dim(expr_filtered) 
```

## Descriptive statistics

```{r}
total_counts <- colSums(expr_filtered)
summary(total_counts)

hist(total_counts, breaks = 50, main = "Total counts per sample",
     xlab = "Total counts", col = "steelblue")
boxplot(total_counts, main = "Total counts per sample")
```

Normalization and scaling

```{r}
vstcounts <- vst(expr_filtered)
```

Heatmap

```{r}
#top variable genes
topN <- 300
sel <- head(order(apply(vstcounts,1,sd), decreasing = TRUE), topN)
mat_top <- vstcounts[sel, ]
pheatmap(mat_top, scale = "row", show_rownames = FALSE, show_colnames = FALSE,
         clustering_method = "complete", main="Heatmap of PDAC patients on top 300 genes")
```

PCA

```{r}
pca_result <- prcomp(t(vstcounts), center = TRUE, scale. = FALSE)  
pca_data <- as.data.frame(pca_result$x)
pca_data$PatientID <- colnames(vstcounts)
```

```{r}
var_explained <- (pca_result$sdev)^2 / sum(pca_result$sdev^2)*100

barplot(var_explained[1:50], main = "Explained Variance (%)",
        xlab = "Principal Component", ylab = "Explained Variance (%)",names.arg = 1:50,
        col = "skyblue")
```

```{r}
PC1=var_explained[1]
PC2=var_explained[2]
PC1
PC2

ggplot(pca_data, aes(x = PC1, y = PC2)) +
    geom_point(size = 3) +
    labs(title = "PCA of SCIE-PANC Bulk RNA-seq Data",
         x = "Principal Component 1 (8.33%)",
         y = "Principal Component 2 (4.46%)") +
    theme_minimal() +
    theme(legend.position = "top")
```

Hierarchical clustering

```{r}
vstcounts.scale=scale(vstcounts)
vstcounts.scale<-t(vstcounts.scale)
vstcounts.dist=dist(vstcounts.scale)
res.hclust<-hclust(vstcounts.dist)

png("dendrogram.png", width=2000, height=1500, res=300)
plot(res.hclust, main = "Cluster Dendrogram")
```

# Deconvolution

```{r}
#| message: false
#| warning: false
deconv = compute.deconvolution(raw.counts = expr_filtered, 
                               methods = c("Quantiseq", "Epidish", 
                                           "DeconRNASeq", "DWLS","MOMF"), 
                               normalized = TRUE, 
                               return = TRUE, 
                               file_name = "Deconv_scie-panc")
```

```{r}
processed_deconvolution = compute.deconvolution.analysis(deconv, corr = 0.7, seed = 123, return = T, file_name="deconv_subsgroups")
```

```{r}
results1<-read.table("Results/Cell_subgroups_deconv_subsgroups.csv", sep = ",", header=T)
results<-read.table("Results/Deconvolution_after_subgrouping_deconv_subsgroups.csv", sep = ",", header=T)
results3<-read.table("Results/Deconvolution_Deconv_scie-panc.csv", sep = ",", header=T)

pheatmap(as.matrix(results[,-1]), cluster_rows=TRUE, cluster_cols=TRUE)
```

ARACNe (normalised after vst) in

```{r}
# Calculer la matrice d'information mutuelle
mim <- build.mim(expr_filtered, method="aracne", estimator = "spearman")

# Appliquer l'algorithme ARACNE
network <- aracne(mim)

# Visualiser le rÃ©seau (optionnel)
library(Rgraphviz)
plot(as(network, "graphNEL"))
```

Then Viper
