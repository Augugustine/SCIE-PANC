---
title: "SCIE-PANC"
params: 
  root: "~/Documents/SCIE-PANC/Data/hg38/"
format: html
editor: visual
---

Bulk RNA analysis in the SCIE-PANC project investigating the tumor microenvironment in pancreatic adenocarcinoma

## Data and libraries initialization

```{r}
#| message: false
library(reshape2)
library(ggplot2)
library(DESeq2)
library(tidyverse)
library(biomaRt)
library(ggfortify)
library(pheatmap)
library(multideconv)
library(dplyr)
library(stringr)
library(igraph)
library(viper)
```

Download the data

```{r}
file_list <- list.files(path = params$root, 
                        pattern = "_htseq_count_all.txt$", 
                        full.names = TRUE, 
                        recursive = TRUE)

length(file_list)
```

Clinical data

```{r}
clinical<-read.csv("clinical_data.csv")
conversion_id<-read.csv("COMPASS_PSCI_ID.csv")
clinical$Subject <- sub("^COMP", "COMP-", clinical$Subject)
clinical<-merge(conversion_id, clinical, by.x="COMPASS.ID", by.y="Subject")
```

Name the column by patient numero and genes column

```{r}
get_prefix <- function(file_path){
  fname <- basename(file_path)
  prefix <- sub("^([^_]+_[^_]+).*", "\\1", fname)
  return(prefix)
}

expr_list <- lapply(file_list, function(f){
  df <- read.table(f, header = TRUE, sep = "\t", stringsAsFactors = FALSE)
  colnames(df)[1] <- "Genes"
  prefix <- get_prefix(f)
  colnames(df)[2] <- prefix
  return(df)
})
```

Merge all the patients

```{r}
expr_matrix <- Reduce(function(x, y) merge(x, y, by = "Genes", all = TRUE), expr_list)
```

```{r}
expr_matrix <- expr_matrix[!expr_matrix$Genes %in% c("__alignment_not_unique",
                                                     "__ambiguous",
                                                     "__no_feature",
                                                     "__not_aligned",
                                                     "__too_low_aQual"), ]
dim(expr_matrix)
head(expr_matrix)
```

Keep only IDs common between RNA matrix and clinical data

```{r}
samples <- data.frame(PCSI.ID = colnames(expr_matrix))
clinical<-merge(clinical, samples, by="PCSI.ID")

samples <- intersect(colnames(expr_matrix), clinical$PCSI.ID)
expr_matrix <- expr_matrix[, c("Genes", samples), drop = FALSE]
```

Add genes annotation and names

```{r}
ensembl <- useMart("ensembl", dataset = "hsapiens_gene_ensembl")

mapping <- getBM(attributes = c("ensembl_gene_id", "hgnc_symbol"),
                 filters = "ensembl_gene_id",
                 values = expr_matrix$Genes,
                 mart = ensembl)

head(mapping)
matrix_annot<-merge(mapping, expr_matrix, by.y="Genes", by.x="ensembl_gene_id")
expr_matrix <- matrix_annot[, -1]
#rownames(expr_matrix) <- expr_matrix$hgnc_symbol
head(expr_matrix)
dim(expr_matrix)
```

```{r}
expr_matrix <- expr_matrix %>%
     filter(hgnc_symbol != "") # filter "" no genes names 
dim(expr_matrix)
```

Genes doublets, keep the genes with the more count

```{r}
expr_matrix <- expr_matrix %>%
  dplyr::rowwise() %>%
  dplyr::mutate(total_counts = sum(dplyr::c_across(-hgnc_symbol))) %>% # calculate the sum of count 
  dplyr::ungroup() %>%
  dplyr::arrange(hgnc_symbol, desc(total_counts)) %>% # order the doublets
  dplyr::distinct(hgnc_symbol, .keep_all = TRUE) %>%
  dplyr::select(-total_counts)
dim(expr_matrix)
```

Preprocessing: genes filtering

1- Filtering based on genes where the total number of reads across all samples

```{r}
expr_matrix<-as.data.frame(expr_matrix)
rownames(expr_matrix) <- expr_matrix$hgnc_symbol
expr_matrix <- expr_matrix[, -1] #Genes Id in rownames
expr_matrix_mat <- as.matrix(expr_matrix)

keep <- rowSums(expr_matrix_mat) > 5  # keep all genes where the total number of reads across all samples is greater than 5
table(keep, useNA="always") 
expr_filtered <- expr_matrix_mat[keep, ]

dim(expr_filtered) 
```

```{r}
saveRDS(expr_filtered, file = "expr_filtered.rds")
```

## Descriptive statistics

```{r}
total_counts <- colSums(expr_filtered)
summary(total_counts)

hist(total_counts, breaks = 50, main = "Total counts per sample",
     xlab = "Total counts", col = "steelblue")
boxplot(total_counts, main = "Total counts per sample")
```

Normalization and scaling

```{r}
vst_matrix <- vst(expr_filtered)
```

```{r}
#saveRDS(vst_matrix, file = "vst_matrix.rds")
```

Heatmap

```{r}
#top variable genes
topN <- 300
sel <- head(order(apply(vst_matrix,1,sd), decreasing = TRUE), topN)
mat_top <- vst_matrix[sel, ]
annot<-clinical[,c("PCSI.ID","Metastatic.Disease.","Moffitt.latest", "kras_subtype","gHRD","Gender")]
annot$gHRD <- ifelse(annot$gHRD %in% c("BRCA1(g)", "BRCA2(g)", "PALB2(g)"), 
                               "yes", 
                               annot$gHRD)
rownames(annot) <- annot$PCSI.ID
annot<-annot[,-1]

my_colors <- list(
  Gender = c(Female = "darkgreen", Male = "lightblue")
)
plot<-pheatmap(mat_top, scale = "row", show_rownames = FALSE, show_colnames = FALSE, annotation_col = annot, clustering_method = "complete", main="Heatmap of PDAC patients on top 300 genes", annotation_colors = my_colors)

ggsave("heatmap.jpeg", plot, width = 5000, height = 4000, units = "px")
```

PCA

```{r}
pca_result <- prcomp(t(vst_matrix), center = TRUE, scale. = FALSE)  
pca_data <- as.data.frame(pca_result$x)
pca_data$PatientID <- colnames(vst_matrix)
pca_data$Sex <- clinical$Gender
pca_data$Alive <- clinical$Alive.
pca_data$kras_mut <- clinical$KRAS_mut 
pca_data$kras_subtype <- clinical$kras_subtype
pca_data$response <- clinical$Best.response.1st.line
pca_data$Moffitt <- clinical$Moffitt.latest
pca_data$Metastatic <- clinical$Metastatic.Disease.
pca_data$Location <- clinical$Location.bx
```

```{r}
var_explained <- (pca_result$sdev)^2 / sum(pca_result$sdev^2)*100

barplot(var_explained[1:50], main = "Explained Variance (%)",
        xlab = "Principal Component", ylab = "Explained Variance (%)",names.arg = 1:50,
        col = "skyblue")
```

```{r}
PC1=var_explained[1]
PC2=var_explained[2]
PC1
PC2

ggplot(pca_data, aes(x = PC1, y = PC2, color = kras_subtype, shape = Sex)) +
    geom_point(size = 3) +
    labs(title = "PCA Bulk RNA-seq Data PDAC, KRAS subtype and Gender",
         x = "Principal Component 1 (8.33%)",
         y = "Principal Component 2 (4.46%)") +
    theme_minimal() +
    scale_color_manual(values = c("wt" = "blue", "minor" = "lightblue", "balanced"="yellow", "major"="red")) +
    theme(legend.position = "top")
```

```{r}
ggplot(pca_data, aes(x = PC1, y = PC2, color = kras_mut, shape = Sex)) +
    geom_point(size = 3) +
    labs(title = "PCA Bulk RNA-seq Data PDAC, KRAS mutation and Gender",
         x = "Principal Component 1 (8.33%)",
         y = "Principal Component 2 (4.46%)") +
    theme_minimal() +
    scale_color_manual(values = c("G12C" = "blue", "G12D" = "pink", "G12R"="yellow", "G12V"="red", "G12S"="grey","G13D"="darkgrey","Q61H"="darkgreen","Q61K"="orange", "Q61L"="lightblue","Q61R"="black")) +
    theme(legend.position = "top")
```

```{r}
ggplot(pca_data, aes(x = PC1, y = PC2, color = response, shape = Sex)) +
    geom_point(size = 3) +
    labs(title = "PCA Bulk RNA-seq Data PDAC, Response and Gender",
         x = "Principal Component 1 (8.33%)",
         y = "Principal Component 2 (4.46%)") +
    theme_minimal() +
    scale_color_manual(values = c("CR" = "blue", "SD" ="pink", "PD"="red", "NE"="grey","missing"="black", "PR"="lightblue")) +
    theme(legend.position = "top")
```

```{r}
ggplot(pca_data, aes(x = PC1, y = PC2, color = Moffitt, shape = Sex)) +
    geom_point(size = 3) +
    labs(title = "PCA Bulk RNA-seq Data PDAC, Moffitt (basal-like or classical) and Gender",
         x = "Principal Component 1 (8.33%)",
         y = "Principal Component 2 (4.46%)") +
    theme_minimal() +
    scale_color_manual(values = c("basal-like" = "blue", "classical"="red")) +
    theme(legend.position = "top")
```

```{r}
ggplot(pca_data, aes(x = PC1, y = PC2, color = Metastatic, shape = Sex)) +
    geom_point(size = 3) +
    labs(title = "PCA Bulk RNA-seq Data PDAC, Metastatic desease and Gender",
         x = "Principal Component 1 (8.33%)",
         y = "Principal Component 2 (4.46%)") +
    theme_minimal() +
    scale_color_manual(values = c("no" = "blue", "yes"="red")) +
    theme(legend.position = "top")
```

```{r}
ggplot(pca_data, aes(x = PC1, y = PC2, color = Location, shape = Sex)) +
    geom_point(size = 3) +
    labs(title = "PCA Bulk RNA-seq Data PDAC, Location and Gender",
         x = "Principal Component 1 (8.33%)",
         y = "Principal Component 2 (4.46%)") +
    theme_minimal() +
    scale_color_manual(values = c("Pancreas" = "blue", "Adrenal gland" = "pink", "Omentum"="yellow", "Liver"="red", "Lymph Node(s) Supraclav"="grey","Abdominal wall"="darkgreen","Peritoneum"="orange", "Lung"="lightblue","Ovary"="black")) +
    theme(legend.position = "top")
```

Hierarchical clustering

```{r}
vst_matrix.scale=scale(vst_matrix)
vst_matrix.scale<-t(vst_matrix.scale)
vst_matrix.dist=dist(vst_matrix.scale)
res.hclust<-hclust(vst_matrix.dist)

png("dendrogram.png", width=2000, height=1500, res=300)
plot(res.hclust, main = "Cluster Dendrogram")
```

## Deconvolution

```{r}
#| message: false
#| warning: false
deconv = compute.deconvolution(raw.counts = expr_filtered, 
                               methods = c("Quantiseq", "Epidish", 
                                           "DeconRNASeq", "DWLS","MOMF"), 
                               normalized = TRUE, 
                               return = TRUE, 
                               file_name = "Deconv_scie-panc")
```

```{r}
processed_deconvolution = compute.deconvolution.analysis(deconv, corr = 0.7, seed = 123, return = T, file_name="deconv_subsgroups")
```

```{r}
results1<-read.table("Results/Cell_subgroups_deconv_subsgroups.csv", sep = ",", header=T)
results<-read.table("Results/Deconvolution_after_subgrouping_deconv_subsgroups.csv", sep = ",", header=T)
rownames(results) <- results$X
results <- results[,-1]
results3<-read.table("Results/Deconvolution_Deconv_scie-panc.csv", sep = ",", header=T)
```

```{r}
pheatmap(t(results), scale = "row", color = colorRampPalette(c("blue", "white", "red"))(100), breaks = seq(-4, 4, length.out = 101), show_rownames = TRUE, show_colnames = TRUE, clustering_method = "complete", main="Heatmap Deconvolution")
```

## Gene regulatory network inference

```{r}
write.table(vst_matrix, file = "matrix_vst.txt", sep = "\t", quote = FALSE, row.names = TRUE, col.names = NA)
```

ARACNe (in Unix)

```{r}
# Calculate mutual information matrix and apply ARACNE algorithm
network <- minet(t(vst_matrix), method="aracne")
```

```{bash}
wget https://humantfs.ccbr.utoronto.ca/download/v_1.01/TF_names_v_1.01.txt

java -Xmx5G -jar ARACNe-AP/dist/aracne.jar -e matrix_vst.txt  -o outputFolder --tfs TF_list.txt --pvalue 1E-8 --seed 1 \
--calculateThreshold

for i in {1..100}
do
java -Xmx5G -jar ARACNe-AP/dist/aracne.jar -e matrix_vst.txt -o outputFolder --tfs TF_names_v_1.01.txt --pvalue 1E-8 --seed $i
done

java -Xmx5G -jar ARACNe-AP/dist/aracne.jar -o outputFolder --consolidate
```

Vizualise the network

```{r}
network<-read.table("network.txt", header=TRUE)
#network <- network[network$pvalue < 0.01, ]

g <- graph_from_data_frame(d=network[, c("Regulator", "Target")], directed=TRUE)
regulators <- unique(network$Regulator)
V(g)$color <- ifelse(V(g)$name %in% regulators, "red", "lightblue") # color the regulators  in red and target in blue

E(g)$weight <- network$MI

plot(g,
     vertex.size=20,
     vertex.label.cex=0.8,
     vertex.label.color="black",
     edge.width=E(g)$weight*5,
     edge.arrow.size=0.5,
     main="ARACNE network for bulk data PADC")
```

Viper

```{r}
# Conversion the network in regulon
regulon <- aracne2regulon("network.txt", vst_matrix)

# VIPER
viper_activity <- viper(vst_matrix, regulon, verbose = FALSE)
```

```{r}
pca <- prcomp(t(viper_activity), scale.=TRUE)
pca_df <- data.frame(pca$x, Condition = your_conditions_vector)
ggplot(pca_df, aes(x=PC1, y=PC2, color=Condition)) +
  geom_point(size=3) +
  theme_minimal()
```

```{r}
var_genes <- head(order(apply(viper_activity, 1, var), decreasing=TRUE), 50)
pheatmap(viper_activity[var_genes, ], scale="row",
         show_rownames=TRUE, show_colnames=TRUE,
         clustering_distance_rows="euclidean",
         clustering_distance_cols="euclidean")
```
